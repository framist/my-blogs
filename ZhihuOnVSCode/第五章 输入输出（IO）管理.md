#! https://zhuanlan.zhihu.com/p/367073051



# 【操作系统】输入输出（IO）管理 笔记整理

帮 [CS_Lee_](https://me.csdn.net/zimuzi2019) 做的笔记


~~打工人，打工魂~~

*课程内容来自王道考研，侵删*

- [【操作系统】输入输出（IO）管理 笔记整理](#操作系统输入输出io管理-笔记整理)
    - [I/O设备基本概念与分类](#io设备基本概念与分类)
      - [I/O设备](#io设备)
      - [I/O设备的分类——按使用特性](#io设备的分类按使用特性)
      - [I/O设备的分类——按传输速率分类](#io设备的分类按传输速率分类)
      - [I/O设备的分类——按信息交换的单位分类](#io设备的分类按信息交换的单位分类)
    - [I/O控制器](#io控制器)
      - [I/O设备的机械部件](#io设备的机械部件)
      - [I/O设备的电子部件（I/O控制器）](#io设备的电子部件io控制器)
      - [I/O控制器的组成](#io控制器的组成)
      - [内存映像I/O v.s. 寄存器独立编址](#内存映像io-vs-寄存器独立编址)
    - [I/O 控制方式](#io-控制方式)
      - [程序直接控制方式](#程序直接控制方式)
      - [中断驱动方式](#中断驱动方式)
      - [DMA 方式](#dma-方式)
      - [通道控制方式](#通道控制方式)
    - [I/O软件层次结构](#io软件层次结构)
      - [用户层软件](#用户层软件)
      - [设备独立性软件](#设备独立性软件)
      - [设备驱动程序](#设备驱动程序)
      - [中断处理程序](#中断处理程序)
    - [I/O核心子系统](#io核心子系统)
      - [这些功能要在哪个层次实现？](#这些功能要在哪个层次实现)
      - [I/O调度](#io调度)
      - [设备保护](#设备保护)
      - [假脱机技术（`SPOOLing`技术）](#假脱机技术spooling技术)
        - [脱机技术](#脱机技术)
        - [输入井和输出井](#输入井和输出井)
        - [实现例子：共享打印机原理分析](#实现例子共享打印机原理分析)
    - [设备的分配与回收](#设备的分配与回收)
      - [设备分配时应考虑的因素](#设备分配时应考虑的因素)
      - [静态分配和动态分配](#静态分配和动态分配)
      - [设备分配管理中的数据结构](#设备分配管理中的数据结构)
        - [设备控制表（DCT）](#设备控制表dct)
        - [控制器控制表（COCT）](#控制器控制表coct)
        - [通道控制表（CHCT）](#通道控制表chct)
        - [系统设备表（SDT）](#系统设备表sdt)
      - [设备分配的步骤](#设备分配的步骤)
      - [设备分配步骤的改进](#设备分配步骤的改进)
    - [缓冲区管理](#缓冲区管理)
      - [什么是缓冲区？](#什么是缓冲区)
      - [缓冲区有什么作用？](#缓冲区有什么作用)
      - [单缓冲](#单缓冲)
      - [双缓冲](#双缓冲)
      - [使用单/双缓冲在通信时的区别](#使用单双缓冲在通信时的区别)
      - [循环缓冲区](#循环缓冲区)
      - [缓冲池](#缓冲池)

<!--more-->



### I/O设备基本概念与分类



![Image](https://pic4.zhimg.com/80/v2-525569c4e5fb34e97fe6f65f14b84023.png)


#### I/O设备

“I/O”就是“输入/输出”（Input/Output）I/O 设备就是可以将数据输入到计算机，或者可以接收计算机输出数据的外部设备，属于计算机中的**硬件部件**。

* 鼠标、键盘——典型的输入型设备
* 显示器——输出型设备
* 移动硬盘——即可输入、又可输出的设备

UNIX 系统将外部设备抽象为一种特殊的**文件**，用户可以使用与文件操作相同的方式对外部设备进行操作。

* `Write`操作：向外部设备写出数据

* `Read`操作：从外部设备读入数据

  
  
#### I/O设备的分类——按使用特性



![Image](https://pic4.zhimg.com/80/v2-d094e3b7d6a504d57aea4e11f1567ad3.png)

#### I/O设备的分类——按传输速率分类

*不常做考点考察*

![Image](https://pic4.zhimg.com/80/v2-919bdba35d4d05fa846a2697ba3d2dd6.png)!



#### I/O设备的分类——按信息交换的单位分类

![Image](https://pic4.zhimg.com/80/v2-c259baa5025a4973dfc079650eb2de6e.png)





### I/O控制器


![Image](https://pic4.zhimg.com/80/v2-e7a929c0d33f361d3843f5b2363bb74e.png)



#### I/O设备的机械部件



I/O设备的**机械部件**主要用来执行具体I/O操作。如我们看得见摸得着的鼠标/键盘的按钮；显示器的LED屏；移动硬盘的磁臂、磁盘盘面。

 I/O设备的**电子部件**通常是一块插入主板扩充槽的印刷电路板。



#### I/O设备的电子部件（I/O控制器）

CPU无法直接控制I/O设备的机械部件，因此I/O设备还要有一个电子部件作为CPU和I/O设备机械部 件之间的“中介”，用于实现 CPU 对设备的控制。 

这个电子部件就是**I/O控制器**，又称**设备控制器**。CPU 可控制 I/O 控制器，又由 I/O 控制器来控制设备 的机械部件。



![Image](https://pic4.zhimg.com/80/v2-728ad4860208c67ab5770fee1d4a32c7.png)



#### I/O控制器的组成


![Image](https://pic4.zhimg.com/80/v2-ad93c2d7dbb37a52796c28a9bf648fc0.png)


值得注意的小细节：

①一个 I/O 控制器可能会对应多个设备；

②数据寄存器、控制寄存器、状态寄存器可能有多个（如：每个控制/状态寄存器对应一个具体的设备），且这些寄存器都要有相应的地址，才能方便 CPU 操作。有的计算机会让这些寄存器占用内存地址的一部分，称为**内存映像I/O**；另一些计算机则采用 I/O 专用地址，即**寄存器独立编址**。





#### 内存映像I/O v.s. 寄存器独立编址

![Image](https://pic4.zhimg.com/80/v2-be02a42e16a02ec9bd83b74cadea964e.png)


### I/O 控制方式

![Image](https://pic4.zhimg.com/80/v2-b9c135c9dc9c4a6512cbcb1b327f5021.png)


需要注意的问题：

1. 完成一次读/写操作的流程
2. CPU 干预的频率
3. 数据传送的单位
4.  数据的流向
5. 主要缺点和主要优点



#### 程序直接控制方式


![Image](https://pic4.zhimg.com/80/v2-4824c86ddd780f3ff74dc680fbc67cca.png)





==Key word：轮询==

![Image](https://pic4.zhimg.com/80/v2-92d9a9ed3fce18173c573f06b489cc9e.png)

**优点**：实现简单。在读/写指令之后，加上实现循环检查的 一系列指令即可（因此才称为“程序直接控制方式”） 

**缺点**：CPU 和 I/O 设备只能串行工作，CPU 需要一直轮询检查，长期处于“忙等”状态，CPU 利用率低。



#### 中断驱动方式

![Image](https://pic4.zhimg.com/80/v2-9a0041018fc22b1d5e9812ea81a3b845.png)

> 去看看 B 站蛋黄派大师兄“操作系统运行机制（小补充）”

![Image](https://pic4.zhimg.com/80/v2-89e067920d221f6374eec7bf87a01323.png)

==Key word：中断==



**优点**：与“程序直接控制方式”相比，在“中断驱动方式”中，I/O 控 制器会通过中断信号主动报告I/O已完成，CPU不再需要不停地轮询。CPU和I/O设备可并行工作，CPU利用率得到明显提升。 

**缺点**：每个字在 I/O 设备与内存之间的传输，都需要经过 CPU。而频繁的中断处理会消耗较多的 CPU 时间。





#### DMA 方式

与“中断驱动方式”相比，==DMA==方式（ **Direct Memory Access**，直接存储器存取。主要用于块设备的 I/O控制）有这样几个改进： 

①数据的传送单位是“块”。不再是一个字、一个字的传送； 

②数据的流向是从设备直接放入内存，或者从内存直接到设备。不再需要 CPU 作为“快递小哥”。

③仅在传送一个或多个数据块的开始和结束时，才需要 CPU 干预。

![Image](https://pic4.zhimg.com/80/v2-8a77797390cebda9452da136f77afb82.png)



![image-20210320120250257](InputOutputManage/image-20210320120250257.png)







![image-20210320120320356](InputOutputManage/image-20210320120320356.png)



**优点**：数据传输以“块”为单位，CPU 介入频率进一步降低。数据的传输不再需要先经过 CPU 再写入内 存，数据传输效率进一步增加。CPU 和 I/O 设备的并行性得到提升。

**缺点**：CPU 每发出一条 I/O 指令，只能读/写一个或多个连续的数据块。如果要读/写多个离散存储的数据块，或者要将数据分别写到不同的内存区域时，CPU 要分别发出多条 I/O指令，进行多次中断处理才能完成。







#### 通道控制方式

==通道==：一种**硬件**，可以理解为是“弱鸡版的 CPU”。通道可以识别并执行一系列**通道指令**

![image-20210320120458983](./InputOutputManage/image-20210320120458983.png)





![image-20210320120553202](InputOutputManage/image-20210320120553202.png)



**缺点**：实现复杂，需要专门的通道硬件支持

**优点**：CPU、通道、I/O 设备可并行工作，资源利用率很高。



### I/O软件层次结构

![image-20210320122201777](InputOutputManage/image-20210320122201777.png)



![image-20210320122210472](InputOutputManage/image-20210320122210472.png)



![image-20210320122238413](InputOutputManage/image-20210320122238413.png)





#### 用户层软件



![image-20210320121159418](InputOutputManage/image-20210320121159418.png)





#### 设备独立性软件

* ①向上层提供统一的调用接口（如 read/write 系统调用）

![image-20210320121224813](InputOutputManage/image-20210320121224813.png)

* ②设备的保护

![image-20210320121407038](InputOutputManage/image-20210320121407038.png)

* ③差错处理



![image-20210320121245064](InputOutputManage/image-20210320121245064.png)

* ⑤数据缓冲区管理



![image-20210320121311294](InputOutputManage/image-20210320121311294.png)

* ⑤数据缓冲区管理



![image-20210320121436462](InputOutputManage/image-20210320121436462.png)

* ⑥建立逻辑设备名到物理设备名的映射关系；根据设备类 型选择调用相应的驱动程序



![image-20210320121446785](InputOutputManage/image-20210320121446785.png)

---



![image-20210320121653120](InputOutputManage/image-20210320121653120.png)



#### 设备驱动程序

**思考：为什么不同类型的 I/O 设备需要有不同的驱动程序处理？**

* 各式各样的设备，外形不同，其内部的 电子部件（I/O 控制器）也有可能不同
* 不同设备的内部硬件特性也不同，这些特性只有厂 家才知道，因此厂家须提供与设备相对应的驱动程 序，CPU 执行驱动程序的指令序列，来完成设置设 备寄存器，检查设备状态等工作



![image-20210320122042137](InputOutputManage/image-20210320122042137.png)



#### 中断处理程序



![image-20210320122106129](InputOutputManage/image-20210320122106129.png)



### I/O核心子系统

![image-20210320122506970](InputOutputManage/image-20210320122506970.png)

![image-20210320122455139](InputOutputManage/image-20210320122455139.png)

#### 这些功能要在哪个层次实现？

![image-20210320122343719](InputOutputManage/image-20210320122343719.png)



#### I/O调度

![image-20210320122409594](InputOutputManage/image-20210320122409594.png)

#### 设备保护

![image-20210320122432293](InputOutputManage/image-20210320122432293.png)

#### <u>假</u>脱机技术（`SPOOLing`技术）

![image-20210320123213956](InputOutputManage/image-20210320123213956.png)

##### 脱机技术

手工操作阶段：主机直接从 I/O设备获得数据，由于设备速度慢，主机速度很快。人机速度矛盾明显，主机要浪费很多时间来等待设备

批处理阶段引入了脱机输入/输出技术（用磁带完成）：

![image-20210320122642654](InputOutputManage/image-20210320122642654.png)



##### 输入井和输出井

![image-20210320122712052](InputOutputManage/image-20210320122712052.png)



![image-20210320122747015](InputOutputManage/image-20210320122747015.png)



![image-20210320122803321](InputOutputManage/image-20210320122803321.png)



![image-20210320122825144](InputOutputManage/image-20210320122825144.png)





![image-20210320122847503](InputOutputManage/image-20210320122847503.png)





##### 实现例子：共享打印机原理分析



**独占式设备**——只允许各个进程串行使用的设备。一段时间内只能满足一个进程的请求。 

**共享设备**——允许多个进程“同时”使用的设备（宏观上同时使用，微观上可能是交替使 用）。可以同时满足多个进程的使用请求。



![image-20210320123002295](InputOutputManage/image-20210320123002295.png)



![image-20210320123027516](InputOutputManage/image-20210320123027516.png)

当多个用户进程提出输出打印的请求时，系统会答应它们的请求，但是并不是真正把打印机分配给他们，而是由假脱机管理进程为每个进程做两件事： 

（1）在磁盘输出井中为进程申请一个**空闲缓冲区**（也就是说，这个缓冲区是在磁盘上的），并将要打 印的数据送入其中； 

（2）为用户进程申请一张空白的**打印请求表**，并将用户的打印请求填入表中（其实就是用来说明用户 的打印数据存放位置等信息的），再将该表挂到假脱机文件队列上。当打印机空闲时，输出进程会从文件队列的队头取出一张打印请求表，并根据表中的要求将要打印的数 据从输出井传送到输出缓冲区，再输出到打印机进行打印。用这种方式可依次处理完全部的打印任务。



虽然系统中只有一个台打印机，但每个进程提出打印请求时，系统都会为在输出井中为 其分配一个存储区（相当于分配了一个逻辑设备），使每个用户进程都觉得自己在独占 一台打印机，从而实现对打印机的共享。SPOOLing 技术可以把一台物理设备**虚拟**成逻辑上的多台设备，**可将独占式设备改造成共 享设备**。





### 设备的分配与回收

![image-20210416170604930](InputOutputManage/image-20210416170604930.png)



#### 设备分配时应考虑的因素



![image-20210320123449596](InputOutputManage/image-20210320123449596.png)





设备的固有属性可分为三种：独占设备、共享设备、虚拟设备。 

- **独占设备**——一个时段只能分配给一个进程（如打印机） 
- **共享设备**——可同时分配给多个进程使用（如磁盘），各进程往往是宏观上同时共享使用设备，而微观上交替使用。
- **虚拟设备**——采用 SPOOLing 技术将独占设备改造成虚拟的共享设备，可同时分配给多个进程使 用（如采用 SPOOLing 技术实现的共享打印机）



设备的**分配算法**：先来先服务、优先级高者优先、短任务优先 ……



![image-20210320123559183](InputOutputManage/image-20210320123559183.png)





#### 静态分配和动态分配

* 静态分配：进程运行前为其分配全部所需资源，运行结束后归还资源
  * 破坏了“请求和保持”条件，不会发生死锁
* 动态分配：进程运行过程中动态申请设备资源

#### 设备分配管理中的数据结构

![image-20210320123901165](InputOutputManage/image-20210320123901165.png)



“设备、控制器、通道”之间的关系：

一个通道可控制多个设备控制器，每个设备控制器可控制多个设备。



##### 设备控制表（DCT）

`设备控制表（DCT）`：系统为每个设备配置一张 DCT，用于记录设备情况

![image-20210320123948380](InputOutputManage/image-20210320123948380.png)

##### 控制器控制表（COCT）

`控制器控制表（COCT）`：每个设备控制器都会对应一张 COCT。操作系统根据 COCT 的信息对控制器 进行操作和管理。

![image-20210320124057283](InputOutputManage/image-20210320124057283.png)

##### 通道控制表（CHCT）

`通道控制表（CHCT）`：每个通道都会对应一张 CHCT。操作系统根据 CHCT 的信息对通道进行操作和 管理。

![image-20210320124123403](InputOutputManage/image-20210320124123403.png)

##### 系统设备表（SDT）

`系统设备表（SDT）`：记录了系统中全部设备的情况，每个设备对应一个表目。

![image-20210320124149370](InputOutputManage/image-20210320124149370.png)



#### 设备分配的步骤

①根据进程请求的<u>物理设备</u>名查找**SDT**（注：物理设备名是进程请求分配设备时提供的参数） 

![image-20210416165733819](InputOutputManage/image-20210416165733819.png)

②根据 SDT 找到 DCT，若设备忙碌则将进程 PCB 挂到<u>设备等待队列</u>中，不忙碌则将设备分配给进程。

![image-20210416165744331](InputOutputManage/image-20210416165744331.png)

③根据 DCT 找到**COCT**，若控制器忙碌则将进程 PCB 挂到<u>控制器等待队列</u>中，不忙碌则将控制器分配 给进程。

![image-20210416165801935](InputOutputManage/image-20210416165801935.png)



④根据 COCT 找到**CHCT**，若通道忙碌则将进程 PCB 挂到<u>通道等待队列</u>中，不忙碌则将通道分配给进 程。

![image-20210416165940361](InputOutputManage/image-20210416165940361.png)

注：只有设备、控制器、通道三者都分配成功时，这次设备分配才算成功，之后便可启动 I/O 设备 进行数据传送

#### 设备分配步骤的改进

**缺点：** 

①用户编程时必须使用“物理设备名”，底层细节对用户不透 明，不方便编程 

②若换了一个物理设备，则程序无法运行 

③若进程请求的物理设备正在忙碌，则即使系统中还有同类型 的设备，进程也必须阻塞等待



**改进方法：**

建立逻辑设备名与物理设备名的映射机制，用户编程时只需提供逻辑设备名

![image-20210416170233485](InputOutputManage/image-20210416170233485.png)



![image-20210416170340615](InputOutputManage/image-20210416170340615.png)



### 缓冲区管理

![image-20210416172158531](InputOutputManage/image-20210416172158531.png)

#### 什么是缓冲区？ 

缓冲区是一个存储区域，可以由专门的硬件寄存器组成，也可利用内存作为缓冲区。 

使用<u>硬件作为缓冲区的成本较高，容量也较小</u>，一般仅用在对速度要求非常高的场合（如存储器 管理中所用的联想寄存器，由于对页表的访问频率极高，因此使用速度很快的联想寄存器来存放 页表项的副本） 

一般情况下，更多的是==利用内存作缓冲区==，“设备独立性软件”的缓冲区管理就是要组织管理 好这些缓冲区

![image-20210416170855041](InputOutputManage/image-20210416170855041.png)

#### 缓冲区有什么作用？

![image-20210416170909175](InputOutputManage/image-20210416170909175.png)



#### 单缓冲

假设某用户进程请求某种块设备读入若干块的数据。若采用单缓冲的策略，操作系统会在<u>主存</u>中<u>为其分配一个缓冲区</u>（若题目中没有特别说明，一个缓冲区的大小就是一个块）。 

**注意**：当缓冲区数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出；当缓冲区为空时，可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出。

![image-20210416171008435](InputOutputManage/image-20210416171008435.png)

![image-20210416171043861](InputOutputManage/image-20210416171043861.png)

![image-20210416171145013](InputOutputManage/image-20210416171145013.png)



==结论：采用**单缓冲**策略，处理一块数据平均耗时 $MAX(C,T)+M$==

#### 双缓冲

![image-20210416171415421](InputOutputManage/image-20210416171415421.png)





![image-20210416171427258](InputOutputManage/image-20210416171427258.png)

==结论：采用**双缓冲**策略，处理一个数据块的平均耗时为 $Max (T, C+M)$==



#### 使用单/双缓冲在通信时的区别

两台机器之间通信时，可以配置缓冲区用于数据的发送和接受。

![image-20210416171614521](InputOutputManage/image-20210416171614521.png)

显然，若两个相互通信的机器只设置单缓冲区，在任一时刻只能实现数据的单向传输。

![image-20210416171638382](InputOutputManage/image-20210416171638382.png)



若两个相互通信的机器设置双缓冲区，则同一时刻可以实现双向的数据传输。 

**注**：管道通信中的“<u>管道</u>”其实就是缓冲区。要实现数据的<u>双向传输</u>，必须设置<u>两个管道</u>

#### 循环缓冲区

将多个<u>大小相等</u>的缓冲区链接成一个<u>循环队列</u>。 

**注**：以下图示中，橙色表示已充满数据的缓冲区，绿色表示空缓冲区。

![image-20210416171836438](InputOutputManage/image-20210416171836438.png)



#### 缓冲池

缓冲池由系统中共用的缓冲区组成。这些缓冲区按使用状况可以分为：空缓冲队列、装满输入数 据的缓冲队列（输入队列）、装满输出数据的缓冲队列（输出队列）。 

另外，根据一个缓冲区在实际运算中扮演的功能不同，又设置了四种工作缓冲区：

- 用于收容输入 数据的工作缓冲区（`hin`）、
- 用于提取输入数据的工作缓冲区（`sin`）、
- 用于收容输出数据的工作缓 冲区（`hout`）、
- 用于提取输出数据的工作缓冲区（`sout`）



![image-20210416172008219](InputOutputManage/image-20210416172008219.png)



1. 输入进程请求输入数据 
2. 计算进程想要取得一块输入数据 
3. 计算进程想要将准备好的数据冲入缓冲区 
4. 输出进程请求输出数据







>  反正不记也没多大影响。~~咕咕咕~~ 
>
>  ——[CS_Lee_](https://me.csdn.net/zimuzi2019) 

